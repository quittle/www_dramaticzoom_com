#!/bin/bash -e

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" >/dev/null 2>&1 && pwd)"

BUILD_DIR="${ROOT}/build"
LAMBDA_ZIP="${BUILD_DIR}/lambda.zip"

rm -rf "${BUILD_DIR}"
rsync \
        -r \
        --copy-links \
        --exclude 'composer.*' \
        --exclude '.git' \
        --exclude '.git*' \
        --exclude 'LICENSE' \
        --exclude 'Tests' \
        --exclude 'Test' \
        --exclude 'examples-*' \
        --exclude 'tests' \
        --exclude 'docs' \
        --exclude '*.txt' \
        --exclude 'docs-*' \
        --exclude '.docker' \
        --exclude '*.md' \
        --exclude 'aws-sdk-php/features' \
        "${ROOT}/vendor" "${BUILD_DIR}"
# cp -r "${ROOT}/vendor" "${BUILD_DIR}"
cp -r "${ROOT}/dynamic/"* "${BUILD_DIR}"
cp -r "${ROOT}/static/"* "${BUILD_DIR}"

rm -f "${LAMBDA_ZIP}"
(
    cd "${BUILD_DIR}"
    zip -r "${LAMBDA_ZIP}" *
)
